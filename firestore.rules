
/**
 * @file Firestore Security Rules
 * @core-philosophy This ruleset enforces a strict user-ownership model for user-generated content and public read access for supplier data.
 * @data-structure
 *   - /suppliers/{supplierId}: Publicly readable supplier profiles.
 *   - /users/{userId}: Publicly readable user profiles.
 *   - /users/{userId}/searchHistory/{searchId}: Private search history for each user.
 *   - /users/{userId}/transactions/{transactionId}: Private financial transactions for each user.
 *   - /users/{userId}/learningPaths/{pathId}: Private learning paths saved by each user.
 *   - /users/{userId}/marketingCampaigns/{campaignId}: Private marketing campaigns saved by each user.
 *   - /users/{userId}/notes/{noteId}: Private notes for each user.
 * @key-security-decisions
 *   - User listing is disallowed to protect privacy.
 *   - Supplier data is publicly readable.
 *   - User-owned data is strictly limited to the owning user.
 * @denormalization-for-authorization N/A (ownership is based on path).
 * @structural-segregation Private user data is stored under the /users/{userId} collection, while public supplier data is stored at the top level.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows public read access to supplier profiles. Write access is not granted in this prototype.
     * @path /suppliers/{supplierId}
     * @allow (get, list): Anyone can read supplier data.
     * @deny (create, update, delete): No one can create, update, or delete supplier data through client-side rules.
     * @principle Allows public reads, restricts writes.
     */
    match /suppliers/{supplierId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows public read access to user profiles. Write access is restricted to the owning user for profile creation and updates.
     * @path /users/{userId}
     * @allow (get, list): Anyone can read user profile data.
     * @allow (create): A user can create their profile if the userId matches their auth UID.
     * @allow (update, delete): A user can update or delete their profile if the userId matches their auth UID and the document exists.
     * @deny (create, update, delete): Denies operations if the user is not authenticated or the user ID does not match the authenticated user's ID.
     * @principle Enforces user-ownership for profile updates.
     */
    match /users/{userId} {
      allow get, list: if true;
      allow create: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the authenticated user can access their own search history.
     * @path /users/{userId}/searchHistory/{searchId}
     * @allow (create): The user can create a search history entry if the userId matches their auth UID.
     * @allow (get, list): The user can read their own search history entries if the userId matches their auth UID.
     * @allow (update, delete): The user can update or delete their own search history entries if the userId matches their auth UID and the document exists.
     * @deny (create, get, list, update, delete): Denies operations if the user is not authenticated or the user ID does not match the authenticated user's ID.
     * @principle Enforces user-ownership for search history.
     */
    match /users/{userId}/searchHistory/{searchId} {
      allow create: if isOwner(userId);
      allow get, list: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the authenticated user can access their own financial transactions.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (create): The user can create a transaction if the userId matches their auth UID.
     * @allow (get, list): The user can read their own transactions if the userId matches their auth UID.
     * @allow (update, delete): The user can update or delete their own transactions if the userId matches their auth UID and the document exists.
     * @deny (create, get, list, update, delete): Denies operations if the user is not authenticated or the user ID does not match the authenticated user's ID.
     * @principle Enforces user-ownership for financial transactions.
     */
    match /users/{userId}/transactions/{transactionId} {
      allow create: if isOwner(userId);
      allow get, list: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }
    
    /**
     * @description Enforces that only the authenticated user can access their own notes.
     * @path /users/{userId}/notes/{noteId}
     * @allow (create): The user can create a note if the userId matches their auth UID.
     * @allow (get, list): The user can read their own notes if the userId matches their auth UID.
     * @allow (update, delete): The user can update or delete their own notes if the userId matches their auth UID and the document exists.
     * @deny (create, get, list, update, delete): Denies operations if the user is not authenticated or the user ID does not match the authenticated user's ID.
     * @principle Enforces user-ownership for notes.
     */
    match /users/{userId}/notes/{noteId} {
      allow create: if isOwner(userId);
      allow get, list, update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the authenticated user can access their own learning paths.
     * @path /users/{userId}/learningPaths/{pathId}
     * @allow (create): The user can create a learning path if the userId matches their auth UID.
     * @allow (get, list): The user can read their own learning paths if the userId matches their auth UID.
     * @allow (update, delete): The user can update or delete their own learning paths if the userId matches their auth UID and the document exists.
     * @deny (create, get, list, update, delete): Denies operations if the user is not authenticated or the user ID does not match the authenticated user's ID.
     * @principle Enforces user-ownership for learning paths.
     */
    match /users/{userId}/learningPaths/{pathId} {
      allow create: if isOwner(userId);
      allow get, list: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the authenticated user can access their own marketing campaigns.
     * @path /users/{userId}/marketingCampaigns/{campaignId}
     * @allow (create): The user can create a marketing campaign if the userId matches their auth UID.
     * @allow (get, list): The user can read their own marketing campaigns if the userId matches their auth UID.
     * @allow (update, delete): The user can update or delete their own marketing campaigns if the userId matches their auth UID and the document exists.
     * @deny (create, get, list, update, delete): Denies operations if the user is not authenticated or the user ID does not match the authenticated user's ID.
     * @principle Enforces user-ownership for marketing campaigns.
     */
    match /users/{userId}/marketingCampaigns/{campaignId} {
      allow create: if isOwner(userId);
      allow get, list: if isOwner(userId);
      allow update, delete: if isExistingOwner(userId);
    }

    // --- Helper functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
  }
}

    